@page "/week-planner"
@using TeachPlanner.BlazorClient.Components.Shared
@using TeachPlanner.BlazorClient.Components.WeekPlanner
@using TeachPlanner.BlazorClient.State
@using TeachPlanner.Shared.Enums
@using TeachPlanner.Shared.Extensions
@attribute [Authorize]

@inject IHttpClientFactory HttpFactory
@inject ApplicationState AppState
@inject NavigationManager NavManager

@if (Periods.Count == 0)
{
    <LoadingSpinner/>
}
else
{
    <div class="flex gap-5">
        <div class="p-1 flex-grow">
            <!-- Week Planner container grid -->
            <div style="grid-auto-rows: @_gridRows" class="grid grid-cols-[minmax(7rem,_0.3fr),_repeat(5,_1fr)] border-2 gap-0.5 bg-darkGreenBorder border-darkGreenBorder">
                <div class="row-start-1 col-start-1 flex items-center justify-center bg-base text-center text-lg font-bold">Week @WeekNumber</div>
                @for (var i = 0; i < Periods.Count; i++)
                {
                    if (Periods[i].PeriodType == PeriodType.Lesson)
                    {
                        <div class="col-start-1 items-center flex flex-col justify-center border-l-2  text-center text-lg font-semibold bg-base">
                            <h5>Lesson @(i + 1)</h5>
                            <p class="text-sm">@Periods[i].StartTime</p>
                        </div>
                    }
                    else
                    {
                        <div class="col-start-1 items-center flex flex-col justify-center text-center text-lg font-semibold bg-base">
                            <p>@Periods[i].Name</p>
                            <p class="text-sm">@Periods[i].StartTime</p>
                        </div>
                    }
                }
                <!-- Week day headers -->
                @for (var i = 0; i < 5; i++)
                {
                    <div class="col-start-@(i + 2) row-start-1 bg-base">
                        <p class="text-center text-lg">@WeekStart.AddDays(i).DayOfWeek</p>
                        <p class="text-center">@WeekStart.AddDays(i).ToString("d/M")</p>
                    </div>
                }

                <!-- DayPlan Columns -->
                @for (var i = 0; i < 5; i++)
                {
                    var currentLesson = 0;

                    @for (var j = 0; j < Periods.Count; j++)
                    {
                        var row = j + 2;
                        var col = i + 2;

                        if (Periods[j].PeriodType == PeriodType.Lesson)
                        {
                            @* Lesson Plan Cards *@
                            var lessonPlan = GetLessonPlan(i, j);
                            var date = DayPlans[i].Date;
                            var periodNumber = j + 1;
                            var handleClick = () => NavManager.NavigateTo($"/lesson-planner?date={date.Year}/{date.Month}/{date.Day}&periodNumber={periodNumber}&isNewLesson={lessonPlan is null}");
                            var overlapsBreak = Periods.Count > j + 1 && Periods[j + 1].PeriodType == PeriodType.Break;
                            <div class="row-start-@row row-span-@(overlapsBreak && lessonPlan?.NumberOfPeriods > 1 ? lessonPlan?.NumberOfPeriods + 1 : lessonPlan?.NumberOfPeriods) col-start-@col h-full w-full cursor-pointer hover:outline hover:outline-2 hover:outline-offset-[-1px] hover:shadow-inner">
                                @if (lessonPlan is null)
                                {
                                    <button class="h-full w-full bg-base" @onclick=handleClick>
                                        @DayTemplates[i].Lessons[currentLesson].SubjectName
                                    </button>
                                }
                                else
                                {
                                    <div class="flex flex-col items-center h-full w-full bg-@(lessonPlan.Subject.Name.GetCssClassString()) hover:outline hover:outline-2 hover:outline-offset-[-1px] hover:shadow-inner"
                                         @onclick=handleClick>
                                        <p class="font-bold p-2">@lessonPlan.Subject.Name</p>
                                        <p class="text-center px-2 max-h-32 overflow-hidden">@lessonPlan.PlanningNotes</p>
                                    </div>

                                    // Conditionals to handle merging cells for multi-period lessons
                                    if (lessonPlan.NumberOfPeriods > 1)
                                    {
                                        j += lessonPlan.NumberOfPeriods - 1;
                                        if (overlapsBreak)
                                        {
                                            j += 1;
                                        }
                                    }
                                }
                            </div>
                        }
                        else
                        {
                            @* Break Plan Cards *@
                            <div class="row-start-@row col-start-@col bg-slate-300"/>
                        }
                    }
                }
            </div>
            @if (_errorMessage is not null)
            {
                <p class="text-red-500">@_errorMessage</p>
            }
        </div>
        <TermDateSelector TermDates="TermDates" CurrentTerm="CurrentTerm" WeekNumber="WeekNumber" SelectedDate="SelectedDate"/>
    </div>
}